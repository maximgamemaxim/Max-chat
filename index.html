<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Max Chat</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background 0.3s, color 0.3s;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        body.dark-theme {
            background: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%);
        }
        
        .app-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
        }
        
        .dark-theme .app-container {
            background: #1e1e2e;
            color: #e0e0e0;
        }
        
        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        .dark-theme .sidebar {
            background: #252636;
            border-right: 1px solid #3a3a4e;
        }
        
        /* –®–∞–ø–∫–∞ */
        .header {
            padding: 20px;
            background: #0088cc;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dark-theme .header {
            background: #1a365d;
        }
        
        .logo {
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ */
        .channels-section, .dms-section {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dark-theme .section-title {
            color: #aaa;
        }
        
        .add-btn {
            background: none;
            border: none;
            color: #0088cc;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-btn:hover {
            transform: scale(1.1);
        }
        
        .channel-list, .dm-list {
            list-style: none;
        }
        
        .channel-item, .dm-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .channel-item:hover, .dm-item:hover,
        .channel-item.active, .dm-item.active {
            background: #0088cc;
            color: white;
        }
        
        .dark-theme .channel-item:hover,
        .dark-theme .dm-item:hover,
        .dark-theme .channel-item.active,
        .dark-theme .dm-item.active {
            background: #2d3748;
        }
        
        .channel-icon {
            font-size: 18px;
        }
        
        .dm-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #0088cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dark-theme .chat-header {
            background: #252636;
            border-bottom: 1px solid #3a3a4e;
        }
        
        .chat-info h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .dark-theme .chat-info h3 {
            color: #e0e0e0;
        }
        
        .online-count {
            color: #666;
            font-size: 14px;
        }
        
        .dark-theme .online-count {
            color: #aaa;
        }
        
        .user-menu {
            position: relative;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #0088cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 10px 0;
            min-width: 200px;
            z-index: 1000;
            display: none;
        }
        
        .dark-theme .dropdown-menu {
            background: #252636;
            border: 1px solid #3a3a4e;
        }
        
        .dropdown-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #333;
        }
        
        .dark-theme .dropdown-item {
            color: #e0e0e0;
        }
        
        .dropdown-item:hover {
            background: #f0f0f0;
        }
        
        .dark-theme .dropdown-item:hover {
            background: #2d3748;
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .dark-theme .chat-messages {
            background: #1a1a2e;
        }
        
        .message {
            max-width: 70%;
            margin-bottom: 20px;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-in {
            background: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .dark-theme .message-in {
            background: #2d3748;
            color: #e0e0e0;
        }
        
        .message-out {
            background: #0088cc;
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,136,204,0.3);
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 13px;
            margin-bottom: 5px;
            color: #666;
        }
        
        .dark-theme .message-sender {
            color: #aaa;
        }
        
        .message-out .message-sender {
            color: rgba(255,255,255,0.9);
        }
        
        .message-text {
            font-size: 15px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        
        .message-text .mention {
            color: #0088cc;
            font-weight: bold;
            background: rgba(0, 136, 204, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }
        
        .date-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }
        
        .date-divider span {
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            color: #666;
        }
        
        .dark-theme .date-divider span {
            background: #2d3748;
            color: #aaa;
        }
        
        /* –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        .dark-theme .chat-input-container {
            background: #252636;
            border-top: 1px solid #3a3a4e;
        }
        
        .message-input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            background: white;
            color: #333;
        }
        
        .dark-theme .message-input {
            background: #2d3748;
            border-color: #4a5568;
            color: #e0e0e0;
        }
        
        .message-input:focus {
            border-color: #0088cc;
        }
        
        .send-btn {
            background: #0088cc;
            color: white;
            border: none;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            font-size: 22px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .send-btn:hover {
            background: #006699;
        }
        
        /* –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .dark-theme .auth-container {
            background: #252636;
            color: #e0e0e0;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .auth-title h1 {
            color: #0088cc;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .auth-title p {
            color: #666;
            font-size: 16px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        
        .dark-theme .form-group label {
            color: #aaa;
        }
        
        .form-input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            color: #333;
            outline: none;
        }
        
        .dark-theme .form-input {
            background: #2d3748;
            border-color: #4a5568;
            color: #e0e0e0;
        }
        
        .form-input:focus {
            border-color: #0088cc;
        }
        
        .auth-btn {
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #0088cc;
            color: white;
        }
        
        .btn-primary:hover {
            background: #006699;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .dark-theme .btn-secondary {
            background: #2d3748;
            color: #e0e0e0;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .dark-theme .btn-secondary:hover {
            background: #3a3a4e;
        }
        
        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }
        
        .switch-link {
            color: #0088cc;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .error-message {
            color: #ff4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        
        .dark-theme .notification {
            background: #252636;
            color: #e0e0e0;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: 95vh;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .channels-section, .dms-section {
                padding: 10px;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div class="app-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div class="header">
                <div class="logo">
                    <span>üí¨</span>
                    Max Chat
                </div>
                <button class="theme-toggle" id="theme-toggle">üåô</button>
            </div>
            
            <!-- –ö–∞–Ω–∞–ª—ã -->
            <div class="channels-section">
                <div class="section-title">
                    <span>–ö–ê–ù–ê–õ–´</span>
                    <button class="add-btn" id="add-channel-btn" title="–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª">+</button>
                </div>
                <ul class="channel-list" id="channel-list">
                    <li class="channel-item active" data-channel="general" onclick="switchChannel('general')">
                        <span class="channel-icon">#</span>
                        <span>general</span>
                    </li>
                    <li class="channel-item" data-channel="random" onclick="switchChannel('random')">
                        <span class="channel-icon">#</span>
                        <span>random</span>
                    </li>
                    <li class="channel-item" data-channel="help" onclick="switchChannel('help')">
                        <span class="channel-icon">#</span>
                        <span>help</span>
                    </li>
                </ul>
            </div>
            
            <!-- –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="dms-section">
                <div class="section-title">
                    <span>–õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø</span>
                    <button class="add-btn" id="add-dm-btn" title="–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">+</button>
                </div>
                <ul class="dm-list" id="dm-list">
                    <!-- DM –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </ul>
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-info">
                    <h3 id="chat-title"># general</h3>
                    <div class="online-count" id="online-count">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>
                
                <div class="user-menu">
                    <div class="user-avatar" id="user-avatar" onclick="toggleDropdown()">
                        ?
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu">
                        <button class="dropdown-item" onclick="showProfile()">
                            <span>üë§</span> –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                        </button>
                        <button class="dropdown-item" onclick="toggleTheme()">
                            <span id="theme-icon">üåô</span> –¢—ë–º–Ω–∞—è —Ç–µ–º–∞
                        </button>
                        <button class="dropdown-item" onclick="logout()">
                            <span>üö™</span> –í—ã–π—Ç–∏
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="chat-messages" id="chat-messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="chat-input-container">
                <input type="text" class="message-input" id="message-input" 
                       placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (–¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ @–∏–º—è)">
                <button class="send-btn" id="send-btn">
                    ‚Üë
                </button>
            </div>
        </div>
    </div>
    
     <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-overlay" id="auth-overlay">
        <div class="auth-container">
            <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
            <div class="auth-title">
                <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
                <p>–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</p>
            </div>
            
            <div class="auth-form" id="login-form">
                <div class="form-group">
                    <label for="login-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" class="form-input" id="login-username" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    <div class="error-message" id="login-username-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="login-password" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    <div class="error-message" id="login-password-error"></div>
                </div>
                
                <button class="auth-btn btn-primary" id="login-btn">
                    –í–æ–π—Ç–∏
                </button>
                
                <div class="auth-switch">
                    –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?
                    <span class="switch-link" onclick="showRegisterForm()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                </div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div class="auth-form" id="register-form" style="display: none;">
                <div class="form-group">
                    <label for="register-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                    <input type="text" class="form-input" id="register-username" 
                           placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    <div class="error-message" id="register-username-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="register-password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="register-password" 
                           placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)">
                    <div class="error-message" id="register-password-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="register-confirm-password">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" class="form-input" id="register-confirm-password" 
                           placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                    <div class="error-message" id="register-confirm-password-error"></div>
                </div>
                
                <button class="auth-btn btn-primary" id="register-btn">
                    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                </button>
                
                <div class="auth-switch">
                    –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?
                    <span class="switch-link" onclick="showLoginForm()">–í–æ–π—Ç–∏</span>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyDdey6ZroD4KsiPiD2dnVfQe3I3OW3MPV8",
        authDomain: "max-chat-f9319.firebaseapp.com",
        databaseURL: "https://max-chat-f9319-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "max-chat-f9319",
        storageBucket: "max-chat-f9319.firebasestorage.app",
        messagingSenderId: "1013158224179",
        appId: "1:1013158224179:web:c4a052ca2e86034de59e46"
    };
// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let currentUser = null;
let currentUserId = null;
let currentChat = 'general';
let chatType = 'channel'; // 'channel' –∏–ª–∏ 'dm'
let messagesListener = null;
let onlineUsers = new Map(); // –ö–∞—Ä—Ç–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π

// ========== –¢–Å–ú–ù–ê–Ø –¢–ï–ú–ê ==========
function initTheme() {
    const savedTheme = localStorage.getItem('maxchat_theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
    }
}

function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    const isDark = document.body.classList.contains('dark-theme');
    
    if (isDark) {
        localStorage.setItem('maxchat_theme', 'dark');
        document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
    } else {
        localStorage.setItem('maxchat_theme', 'light');
        document.getElementById('theme-icon').textContent = 'üåô';
        document.getElementById('theme-toggle').textContent = 'üåô';
    }
    
    toggleDropdown();
}

// ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–û–ú ==========
function toggleDropdown() {
    const dropdown = document.getElementById('dropdown-menu');
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

function showProfile() {
    if (!currentUser) return;
    alert(`üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å:\n\n–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: @${currentUser.username}\n–ò–º—è: ${currentUser.name}\nID: ${currentUser.id}\n–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${new Date(currentUser.joined).toLocaleDateString('ru-RU')}`);
    toggleDropdown();
}

// ========== –ö–ê–ù–ê–õ–´ –ò DM ==========
function switchChannel(channelId) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
    document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-channel="${channelId}"]`).classList.add('active');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º DM —Å–ø–∏—Å–æ–∫
    document.querySelectorAll('.dm-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —á–∞—Ç
    currentChat = channelId;
    chatType = 'channel';
    document.getElementById('chat-title').textContent = `# ${channelId}`;
    document.getElementById('online-count').textContent = '–û–±—â–∏–π –∫–∞–Ω–∞–ª';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    loadMessages();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
document.getElementById('add-channel-btn').addEventListener('click', function() {
    const channelName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞:');
    if (!channelName || channelName.trim().length < 2) {
        alert('–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    const cleanName = channelName.trim().toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∫–∞–Ω–∞–ª
    const existingChannel = document.querySelector(`[data-channel="${cleanName}"]`);
    if (existingChannel) {
        alert('–ö–∞–Ω–∞–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
        switchChannel(cleanName);
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤
    const channelList = document.getElementById('channel-list');
    const newChannel = document.createElement('li');
    newChannel.className = 'channel-item';
    newChannel.dataset.channel = cleanName;
    newChannel.innerHTML = `
        <span class="channel-icon">#</span>
        <span>${cleanName}</span>
    `;
    newChannel.onclick = () => switchChannel(cleanName);
    channelList.appendChild(newChannel);
    
    // –°–æ–∑–¥–∞—ë–º –∫–∞–Ω–∞–ª –≤ Firebase
    database.ref('channels/' + cleanName).set({
        name: cleanName,
        created: Date.now(),
        creator: currentUserId,
        creatorName: currentUser.username,
        type: 'public'
    }).then(() => {
        alert(`–ö–∞–Ω–∞–ª #${cleanName} —Å–æ–∑–¥–∞–Ω!`);
        switchChannel(cleanName);
    }).catch(error => {
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞: ' + error.message);
        channelList.removeChild(newChannel);
    });
});

// –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
document.getElementById('add-dm-btn').addEventListener('click', function() {
    const userName = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (@username) –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:');
    if (!userName || userName.trim().length < 2) {
        alert('–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    const cleanName = userName.trim().toLowerCase();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ DM
    const existingDM = Array.from(document.querySelectorAll('.dm-item')).find(item => 
        item.textContent.toLowerCase().includes(cleanName)
    );
    
    if (existingDM) {
        alert('–î–∏–∞–ª–æ–≥ —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
        existingDM.click();
        return;
    }
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    // –°–µ–π—á–∞—Å —Å–æ–∑–¥–∞—ë–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π DM
    const dmId = `dm_${Date.now()}_${cleanName}`;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ DM
    const dmList = document.getElementById('dm-list');
    const newDM = document.createElement('li');
    newDM.className = 'dm-item';
    newDM.dataset.dm = dmId;
    newDM.innerHTML = `
        <div class="dm-avatar">${cleanName.charAt(0).toUpperCase()}</div>
        <span>${cleanName}</span>
    `;
    newDM.onclick = () => switchToDM(dmId, cleanName);
    dmList.appendChild(newDM);
    
    alert(`–î–∏–∞–ª–æ–≥ —Å @${cleanName} —Å–æ–∑–¥–∞–Ω!`);
    switchToDM(dmId, cleanName);
});

function switchToDM(dmId, dmName) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelectorAll('.dm-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-dm="${dmId}"]`).classList.add('active');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —á–∞—Ç
    currentChat = dmId;
    chatType = 'dm';
    document.getElementById('chat-title').textContent = `üí¨ @${dmName}`;
    document.getElementById('online-count').textContent = '–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    loadMessages();
}

// ========== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ==========
function showLoginForm() {
    document.getElementById('login-form').style.display = 'flex';
    document.getElementById('register-form').style.display = 'none';
    clearErrors();
}

function showRegisterForm() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'flex';
    clearErrors();
}

function clearErrors() {
    document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
        el.textContent = '';
    });
}

function showError(inputId, message) {
    const errorEl = document.getElementById(`${inputId}-error`);
    errorEl.textContent = message;
    errorEl.style.display = 'block';
}

// –í—Ö–æ–¥
document.getElementById('login-btn').addEventListener('click', function() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    
    clearErrors();
    
    if (!username) {
        showError('login-username', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    if (!password) {
        showError('login-password', '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const loginBtn = document.getElementById('login-btn');
    const originalText = loginBtn.textContent;
    loginBtn.textContent = '–í—Ö–æ–¥...';
    loginBtn.disabled = true;
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã Firebase Authentication
    // –°–µ–π—á–∞—Å –∏–º–∏—Ç–∏—Ä—É–µ–º –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    
    // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    database.ref('users').once('value').then((snapshot) => {
        const users = snapshot.val();
        let foundUser = null;
        
        if (users) {
            Object.entries(users).forEach(([userId, userData]) => {
                if (userData.username && userData.username.toLowerCase() === username.toLowerCase()) {
                    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ Firebase Auth
                    // –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    foundUser = { id: userId, ...userData };
                }
            });
        }
        
        if (foundUser) {
            // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
            currentUser = {
                id: foundUser.id,
                username: foundUser.username,
                name: foundUser.name || foundUser.username,
                avatar: foundUser.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(foundUser.username)}&background=0088cc&color=fff`,
                joined: foundUser.joined || Date.now()
            };
            
            currentUserId = foundUser.id;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('maxchat_user', JSON.stringify(currentUser));
            localStorage.setItem('maxchat_user_id', foundUser.id);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firebase
            database.ref('users/' + foundUser.id).update({
                online: true,
                lastSeen: Date.now()
            }).then(() => {
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                updateUserUI();
                hideAuthScreen();
                loadMessages();
                updateOnlineCount();
                loadOnlineUsers();
                
                loginBtn.textContent = originalText;
                loginBtn.disabled = false;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, @${currentUser.username}!`);
            });
        } else {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            loginBtn.textContent = originalText;
            loginBtn.disabled = false;
            showError('login-username', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
    }).catch((error) => {
        loginBtn.textContent = originalText;
        loginBtn.disabled = false;
        showError('login-username', '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
    });
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
document.getElementById('register-btn').addEventListener('click', function() {
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('register-confirm-password').value;
    
    clearErrors();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!username) {
        showError('register-username', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    if (username.length < 3) {
        showError('register-username', '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    if (!/^[a-zA-Z0-9_]+$/.test(username)) {
        showError('register-username', '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ');
        return;
    }
    
    if (!password) {
        showError('register-password', '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    if (password.length < 6) {
        showError('register-password', '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    if (password !== confirmPassword) {
        showError('register-confirm-password', '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    const registerBtn = document.getElementById('register-btn');
    const originalText = registerBtn.textContent;
    registerBtn.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è...';
    registerBtn.disabled = true;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    database.ref('users').once('value').then((snapshot) => {
        const users = snapshot.val();
        let usernameExists = false;
        
        if (users) {
            Object.values(users).forEach(userData => {
                if (userData.username && userData.username.toLowerCase() === username.toLowerCase()) {
                    usernameExists = true;
                }
            });
        }
        
        if (usernameExists) {
            registerBtn.textContent = originalText;
            registerBtn.disabled = false;
            showError('register-username', '–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ');
            return;
        }
        
        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        currentUser = {
            id: userId,
            username: username,
            name: username, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–º—è —Ä–∞–≤–Ω–æ username
            avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(username)}&background=0088cc&color=fff&bold=true`,
            joined: Date.now()
        };
        
        currentUserId = userId;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        database.ref('users/' + userId).set({
            username: username,
            name: username,
            avatar: currentUser.avatar,
            online: true,
            lastSeen: Date.now(),
            joined: Date.now(),
            createdAt: Date.now()
        }).then(() => {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('maxchat_user', JSON.stringify(currentUser));
            localStorage.setItem('maxchat_user_id', userId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUserUI();
            hideAuthScreen();
            loadMessages();
            updateOnlineCount();
            loadOnlineUsers();
            
            registerBtn.textContent = originalText;
            registerBtn.disabled = false;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`–ê–∫–∫–∞—É–Ω—Ç @${username} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            sendWelcomeMessage();
        }).catch((error) => {
            registerBtn.textContent = originalText;
            registerBtn.disabled = false;
            showError('register-username', '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
        });
        
    }).catch((error) => {
        registerBtn.textContent = originalText;
        registerBtn.disabled = false;
        showError('register-username', '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–º–µ–Ω–∏: ' + error.message);
    });
});

function updateUserUI() {
    const avatarEl = document.getElementById('user-avatar');
    if (avatarEl && currentUser.username) {
        avatarEl.textContent = currentUser.username.charAt(0).toUpperCase();
        avatarEl.style.background = '#0088cc';
    }
}

function hideAuthScreen() {
    document.getElementById('auth-overlay').style.display = 'none';
}

// ========== –û–ù–õ–ê–ô–ù –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –£–ü–û–ú–ò–ù–ê–ù–ò–Ø ==========
function loadOnlineUsers() {
    database.ref('users').on('value', (snapshot) => {
        const users = snapshot.val();
        onlineUsers.clear();
        
        if (users) {
            Object.entries(users).forEach(([userId, userData]) => {
                if (userData.online && Date.now() - userData.lastSeen < 300000) {
                    onlineUsers.set(userData.username?.toLowerCase(), {
                        id: userId,
                        username: userData.username,
                        name: userData.name
                    });
                }
            });
        }
    });
}
// ========== –†–ê–ë–û–¢–ê –° –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò ==========
function loadMessages() {
    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª—É—à–∞—Ç–µ–ª—å
    if (messagesListener) {
        const path = chatType === 'channel' ? 'messages/channels/' : 'messages/dms/';
        database.ref(path + currentChat).off('value', messagesListener);
        messagesListener = null;
    }
    
    const path = chatType === 'channel' ? 'messages/channels/' : 'messages/dms/';
    const messagesRef = database.ref(path + currentChat);
    const messagesDiv = document.getElementById('chat-messages');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    messagesDiv.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 24px; margin-bottom: 10px;">üí¨</div>
            –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...
        </div>
    `;
    
    // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    messagesListener = messagesRef.orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
        const messages = snapshot.val();
        
        if (!messages || Object.keys(messages).length === 0) {
            const welcomeText = chatType === 'channel' 
                ? '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –æ–±—â–∏–π —á–∞—Ç!' 
                : '–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!';
                
            messagesDiv.innerHTML = `
                <div class="message message-in" style="text-align: center; max-width: 90%; margin: 20px auto;">
                    <div style="font-size: 36px; margin-bottom: 10px;">${chatType === 'channel' ? 'üëã' : 'üí¨'}</div>
                    <div class="message-sender" style="color: #0088cc; font-weight: bold;">Max Chat</div>
                    <div style="margin: 10px 0;">${welcomeText}</div>
                    <div style="font-size: 14px; color: #666;">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                    <div class="message-time">—Ç–æ–ª—å–∫–æ —á—Ç–æ</div>
                </div>
            `;
            return;
        }
        
        const messagesArray = Object.entries(messages)
            .map(([id, data]) => ({ id, ...data }))
            .sort((a, b) => a.timestamp - b.timestamp);
        
        let html = '';
        let lastDate = null;
        let lastSender = null;
        
        messagesArray.forEach((msg, index) => {
            const msgDate = new Date(msg.timestamp);
            const dateStr = msgDate.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            if (dateStr !== lastDate) {
                html += `
                    <div class="date-divider">
                        <span>${dateStr}</span>
                    </div>
                `;
                lastDate = dateStr;
            }
            
            const timeStr = msgDate.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const isMyMessage = msg.senderId === currentUserId;
            const isSystemMessage = msg.senderId === 'system';
            
            const showSender = !isMyMessage && !isSystemMessage && 
                (lastSender !== msg.senderId || index === 0 ||
                 (msg.timestamp - messagesArray[index - 1].timestamp) > 300000);
            
            if (showSender) {
                lastSender = msg.senderId;
            }
            
            html += `
                <div class="message ${isMyMessage ? 'message-out' : 'message-in'} ${isSystemMessage ? 'system-message' : ''}" 
                     id="msg-${msg.id}">
                    ${showSender && !isSystemMessage ? 
                        `<div class="message-sender">@${msg.senderUsername || 'unknown'}</div>` : ''}
                    <div class="message-text">${formatMessageText(msg.text)}</div>
                    <div class="message-time">
                        ${timeStr}
                        ${isMyMessage ? '<span style="margin-left: 5px;">‚úì‚úì</span>' : ''}
                    </div>
                </div>
            `;
        });
        
        messagesDiv.innerHTML = html;
        
        setTimeout(() => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 100);
    });
}

function sendMessage() {
    if (!currentUser) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        document.getElementById('auth-overlay').style.display = 'flex';
        return;
    }
    
    const input = document.getElementById('message-input');
    let text = input.value.trim();
    
    if (!text) {
        input.focus();
        return;
    }
    
    if (text.length > 2000) {
        alert('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 2000 —Å–∏–º–≤–æ–ª–æ–≤)');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    const mentions = extractMentions(text);
    if (mentions.length > 0) {
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        console.log('–£–ø–æ–º–∏–Ω–∞–Ω–∏—è:', mentions);
    }
    
    const messageData = {
        text: text,
        senderId: currentUser.id,
        senderName: currentUser.name,
        senderUsername: currentUser.username,
        timestamp: Date.now(),
        type: 'text',
        mentions: mentions
    };
    
    input.value = '';
    
    const messagesDiv = document.getElementById('chat-messages');
    const tempId = 'temp_' + Date.now();
    const timeStr = new Date().toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    messagesDiv.insertAdjacentHTML('beforeend', `
        <div class="message message-out" id="${tempId}" style="opacity: 0.8;">
            <div class="message-text">${formatMessageText(text)}</div>
            <div class="message-time">${timeStr} ‚åõ</div>
        </div>
    `);
    
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    const path = chatType === 'channel' ? 'messages/channels/' : 'messages/dms/';
    database.ref(path + currentChat).push(messageData)
        .then((ref) => {
            const tempMsg = document.getElementById(tempId);
            if (tempMsg) {
                tempMsg.style.opacity = '1';
                tempMsg.id = 'msg-' + ref.key;
                tempMsg.querySelector('.message-time').innerHTML = timeStr + ' <span style="margin-left: 5px;">‚úì‚úì</span>';
            }
        })
        .catch((error) => {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            const tempMsg = document.getElementById(tempId);
            if (tempMsg) {
                tempMsg.style.opacity = '0.5';
                tempMsg.querySelector('.message-time').innerHTML = 
                    timeStr + ' <span style="color: #ff4444; margin-left: 5px;">‚úó</span>';
                
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            }
        });
}

function extractMentions(text) {
    const mentionRegex = /@([a-zA-Z0-9_]+)/g;
    const mentions = [];
    let match;
    
    while ((match = mentionRegex.exec(text)) !== null) {
        const username = match[1].toLowerCase();
        if (onlineUsers.has(username)) {
            mentions.push({
                username: username,
                userId: onlineUsers.get(username).id
            });
        }
    }
    
    return mentions;
}

function formatMessageText(text) {
    let formatted = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
    formatted = formatted.replace(
        /@([a-zA-Z0-9_]+)/g,
        (match, username) => {
            const user = onlineUsers.get(username.toLowerCase());
            if (user) {
                return `<span class="mention" title="@${username}" onclick="mentionUser('${username}')">@${username}</span>`;
            }
            return `<span class="mention">@${username}</span>`;
        }
    );
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Å—ã–ª–∫–∏
    formatted = formatted.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank" style="color: #0088cc; text-decoration: underline;">$1</a>'
    );
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    formatted = formatted.replace(/\n/g, '<br>');
    
    return formatted;
}

function mentionUser(username) {
    const input = document.getElementById('message-input');
    const currentText = input.value;
    const mentionText = `@${username} `;
    
    if (currentText.trim() === '') {
        input.value = mentionText;
    } else if (currentText.endsWith(' ')) {
        input.value = currentText + mentionText;
    } else {
        input.value = currentText + ' ' + mentionText;
    }
    
    input.focus();
}

function sendWelcomeMessage() {
    if (!currentUser) return;
    
    database.ref('messages/channels/general').push({
        text: `üëã @${currentUser.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!`,
        senderId: 'system',
        senderName: 'System',
        timestamp: Date.now(),
        type: 'system'
    });
}

// ========== –û–ù–õ–ê–ô–ù –°–¢–ê–¢–£–° ==========
function updateOnlineCount() {
    if (!currentUserId) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å
    database.ref('users/' + currentUserId).update({
        online: true,
        lastSeen: Date.now()
    });
    
    // –°–ª—É—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    database.ref('users').on('value', (snapshot) => {
        const users = snapshot.val();
        let onlineCount = 0;
        let totalCount = 0;
        
        if (users) {
            Object.values(users).forEach(user => {
                totalCount++;
                if (user.online && Date.now() - user.lastSeen < 300000) {
                    onlineCount++;
                }
            });
        }
        
        const onlineCountEl = document.getElementById('online-count');
        if (onlineCountEl && chatType === 'channel') {
            onlineCountEl.textContent = `${onlineCount} –æ–Ω–ª–∞–π–Ω ‚Ä¢ ${totalCount} –≤—Å–µ–≥–æ`;
        }
    });
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üí¨'}</span>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ==========
function initApp() {
    console.log('üî• Max Chat –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–º—ã
    initTheme();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    setupEventListeners();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const savedUser = localStorage.getItem('maxchat_user');
    const savedUserId = localStorage.getItem('maxchat_user_id');
    
    if (savedUser && savedUserId) {
        try {
            currentUser = JSON.parse(savedUser);
            currentUserId = savedUserId;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Firebase
            database.ref('users/' + currentUserId).update({
                online: true,
                lastSeen: Date.now()
            }).then(() => {
                updateUserUI();
                hideAuthScreen();
                loadMessages();
                updateOnlineCount();
                loadOnlineUsers();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                localStorage.clear();
                currentUser = null;
                currentUserId = null;
                document.getElementById('auth-overlay').style.display = 'flex';
            });
            
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
            localStorage.clear();
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    } else {
        document.getElementById('auth-overlay').style.display = 'flex';
    }
}
    function setupEventListeners() {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –∫–Ω–æ–ø–∫–µ
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        
        // –ù–∞–∂–∞—Ç–∏–µ –Ω–∞ —Ç–µ–º—É
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        
        // –í—Ö–æ–¥ –ø–æ Enter –≤ —Ñ–æ—Ä–º–∞—Ö
        document.getElementById('login-username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
        
        document.getElementById('login-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('login-btn').click();
            }
        });
        
        document.getElementById('register-username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('register-btn').click();
            }
        });
        
        document.getElementById('register-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('register-btn').click();
            }
        });
        
        document.getElementById('register-confirm-password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('register-btn').click();
            }
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('dropdown-menu');
            const avatar = document.getElementById('user-avatar');
            
            if (dropdown.style.display === 'block' && 
                !dropdown.contains(event.target) && 
                !avatar.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤—Ö–æ–¥–∞
        document.getElementById('login-username').focus();
    }
    
    // ========== –í–´–•–û–î ==========
    function logout() {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) return;
        
        if (currentUserId) {
            database.ref('users/' + currentUserId).update({
                online: false,
                lastSeen: Date.now()
            });
        }
        
        if (messagesListener) {
            const path = chatType === 'channel' ? 'messages/channels/' : 'messages/dms/';
            database.ref(path + currentChat).off('value', messagesListener);
        }
        
        localStorage.removeItem('maxchat_user');
        localStorage.removeItem('maxchat_user_id');
        
        currentUser = null;
        currentUserId = null;
        currentChat = 'general';
        chatType = 'channel';
        onlineUsers.clear();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
        document.getElementById('auth-overlay').style.display = 'flex';
        document.getElementById('login-form').style.display = 'flex';
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        document.getElementById('register-username').value = '';
        document.getElementById('register-password').value = '';
        document.getElementById('register-confirm-password').value = '';
        clearErrors();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —á–∞—Ç—ã
        document.querySelectorAll('.channel-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector('[data-channel="general"]').classList.add('active');
        document.getElementById('chat-title').textContent = '# general';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä
        document.getElementById('user-avatar').textContent = '?';
        document.getElementById('user-avatar').style.background = '#0088cc';
        
        toggleDropdown();
    }
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    window.addEventListener('DOMContentLoaded', initApp);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (currentUserId) {
            navigator.sendBeacon = navigator.sendBeacon || function() { return false; };
            
            const data = JSON.stringify({
                online: false,
                lastSeen: Date.now()
            });
            
            const url = `${firebaseConfig.databaseURL}/users/${currentUserId}.json`;
            navigator.sendBeacon(url, data);
        }
    });
    
    // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    window.debugMaxChat = {
        reset: () => {
            localStorage.clear();
            location.reload();
        },
        user: () => currentUser,
        firebase: database,
        onlineUsers: () => onlineUsers
    };
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick
  window.switchChannel = switchChannel;
  window.toggleTheme = toggleTheme;
  window.toggleDropdown = toggleDropdown;
  window.showProfile = showProfile;
  window.showLoginForm = showLoginForm;  
  window.showRegisterForm = showRegisterForm;
  window.logout = logout;
    </script>
</body>
</html>